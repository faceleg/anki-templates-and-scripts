<div id="char_image">{{Image}}</div>

<div id="char_sim" class="char-card">{{Simplified}}</div>
<div id="char_trad" class="char-card">{{Traditional}}</div>
<div id="char_zhuyin">{{Zhuyin}}</div>
<div id="char_pinyin">{{Pinyin}}</div>
<div id="char_meaning" class="meaning-card">
  <hr />
  {{Definitions}}
  <hr />
</div>
<div id="char_examples">{{Examples}}</div>

<div class="modal-footer1">
  <a class="btn" id="btnShowMenu" onclick="openSidebar('sidebar')">
    <div class="icon"><i class="material-icons">menu</i></div>
  </a>
  <a class="btn" id="btnPlayAudio">
    <div class="icon"><i class="material-icons">play_arrow</i></div>
  </a>
  <a class="btn" id="btnMoreOptions" onclick="openSidebar('more-info-sidebar')">
    <div class="icon"><i class="material-icons">more_vert</i></div>
  </a>
</div>
<div id="char_deck">
  <div>{{Deck}}</div>
  <div>{{Card}}</div>
  <div id="audio">{{Audio}}</div>
</div>	
<!-- Empty div to allow the setPrefs function to work (it expects a div with an id, and will then show/hide based on classes) -->
<div id="char_examples-parts-of-speech"></div>

<!--sidebar-->

<div id="sidebar" class="sidebar">
  <section>
    <fieldset style="border: none">
      <div class="fieldset-item tappable">
        <div
          class="input-stack"
          style="text-align: center; color: var(--text2)"
        >
          <label for="deck-title">
            <h3 class="brand-title">写汉字</h3>
            <div class="brand-sub-title">xiě hànzì</div>
          </label>
          <a onclick="closeSidebar('sidebar')" class="close-button">✖</a>
        </div>
      </div>
    </fieldset>
  </section>
  <section>
    <fieldset>
      <div class="fieldset-item fs-item-3 practice fs-item-front-back">
        <div
          id="text-front"
          class="input-stack front-back"
          onclick="setActive('text-front')"
        >
          Front
        </div>
        <div
          id="text-back"
          class="input-stack front-back"
          onclick="setActive('text-back')"
        >
          Back
        </div>
      </div>
    </fieldset>
  </section>
  <section>
    <fieldset>
      <div class="fieldset-item fs-item-1 practice">
        <div class="input-stack">
          <label for="reading-practice-select">Practice</label>
        </div>
        <select
          name="practice"
          id="reading-practice-select"
          onchange="setPrefs(this)"
        >
          <option>简</option>
          <option>繁</option>
        </select>
      </div>
    </fieldset>
  </section>
  <section>
    <fieldset>
      <div class="fieldset-item fs-item-1">
        <div class="input-stack">
          <label for="text-pinyin"> Pinyin </label>
        </div>
        <input
          class="tappable"
          type="checkbox"
          id="text-pinyin"
          name="text-pinyin"
          onchange="setPrefs(this)"
        />
      </div>
      <div class="fieldset-item fs-item-1">
        <div class="input-stack">
          <label for="text-zhuyin"> Zhuyin </label>
        </div>
        <input
          class="tappable"
          type="checkbox"
          id="text-zhuyin"
          name="text-zhuyin"
          onchange="setPrefs(this)"
        />
      </div>
      <div class="fieldset-item fs-item-1">
        <div class="input-stack">
          <label for="text-examples"> Examples </label>
        </div>
        <input
          class="tappable"
          type="checkbox"
          id="text-examples"
          name="text-examples"
          onchange="setPrefs(this)"
        />
      </div>
      <div class="fieldset-item fs-item-1">
        <div class="input-stack">
          <label for="text-examples-parts-of-speech">
            Examples - Parts of Speech Headings
          </label>
        </div>
        <input
          class="tappable"
          type="checkbox"
          id="text-examples-parts-of-speech"
          name="text-examples-parts-of-speech"
          onchange="setPrefs(this)"
        />
      </div>
      <div class="fieldset-item fs-item-1">
        <div class="input-stack">
          <label for="text-meaning"> Meaning </label>
        </div>
        <input
          class="tappable"
          type="checkbox"
          id="text-meaning"
          name="text-meaning"
          onchange="setPrefs(this)"
        />
      </div>
      <div class="fieldset-item fs-item-1">
        <div class="input-stack">
          <label for="text-sim"> Simplified </label>
        </div>
        <input
          class="tappable"
          type="checkbox"
          id="text-sim"
          name="text-sim"
          onchange="setPrefs(this)"
        />
      </div>
      <div class="fieldset-item fs-item-1">
        <div class="input-stack">
          <label for="text-trad"> Traditional </label>
        </div>
        <input
          class="tappable"
          type="checkbox"
          id="text-trad"
          name="text-trad"
          onchange="setPrefs(this)"
        />
      </div>
    </fieldset>
  </section>
  <section>
    <fieldset>
      <a href="https://github.com/krmanik/Anki-xiehanzi">
        <div class="fieldset-item tappable">
          <span style="font-size: 14px; text-align: center"
            >View it on GitHub</span
          >
        </div>
      </a>
    </fieldset>
  </section>
</div>
<div id="more-info-sidebar" class="more-info-sidebar">
  <a class="fieldset-item tappable">
    <div class="more-side-brand">
      <div class="brand-title">写汉字</div>
      <div class="brand-sub-title">xiě hànzì</div>
    </div>
    <div
      onclick="closeSidebar('more-info-sidebar')"
      class="close-button close2"
    >
      ✖
    </div>
  </a>
  <a
    class="fieldset-item tappable"
    id="plecoMobile"
    href="plecoapi://x-callback-url/df?hw={{Simplified}}"
  >
    <img src="_pleco.png" />
    <small>Pleco</small>
  </a>
  <a
    class="fieldset-item tappable"
    href="http://dict.youdao.com/search?q={{Simplified}}"
  >
    <img src="_youdao.png" />
    <small>Youdao</small>
  </a>
  <a
    class="fieldset-item tappable"
    href="https://hanzicraft.com/character/{{Simplified}}"
  >
    <img src="_hanzicraft.png" />
    <small>HanziCraft</small>
  </a>
  <a
    class="fieldset-item tappable"
    href="https://characterpop.com/characters/{{Simplified}}"
  >
    <img src="_characterpop.svg" />
    <small>CharacterPop</small>
  </a>
  <a
    class="fieldset-item tappable"
    href="http://rtega.be/chmn/index.php?c={{Simplified}}"
  >
    <img src="_rtega.png" />
    <small>Rtega</small>
  </a>
  <a
    class="fieldset-item tappable"
    href="https://tatoeba.org/en/sentences/search?from=cmn&query={{Simplified}}&to="
  >
    <img src="_tatoeba.png" />
    <small>Tatoeba</small>
  </a>
</div>
<!-----sidebar------>

<!-- Persistence -->
<script>
    // prettier-ignore
  // v1.1.8 - https://github.com/SimonLammer/anki-persistence/blob/584396fea9dea0921011671a47a0fdda19265e62/script.js
  if(void 0===window.Persistence){var e="github.com/SimonLammer/anki-persistence/",t="_default";if(window.Persistence_sessionStorage=function(){var i=!1;try{"object"==typeof window.sessionStorage&&(i=!0,this.clear=function(){for(var t=0;t<sessionStorage.length;t++){var i=sessionStorage.key(t);0==i.indexOf(e)&&(sessionStorage.removeItem(i),t--)}},this.setItem=function(i,n){void 0==n&&(n=i,i=t),sessionStorage.setItem(e+i,JSON.stringify(n))},this.getItem=function(i){return void 0==i&&(i=t),JSON.parse(sessionStorage.getItem(e+i))},this.removeItem=function(i){void 0==i&&(i=t),sessionStorage.removeItem(e+i)},this.getAllKeys=function(){for(var t=[],i=Object.keys(sessionStorage),n=0;n<i.length;n++){var s=i[n];0==s.indexOf(e)&&t.push(s.substring(e.length,s.length))}return t.sort()})}catch(n){}this.isAvailable=function(){return i}},window.Persistence_windowKey=function(i){var n=window[i],s=!1;"object"==typeof n&&(s=!0,this.clear=function(){n[e]={}},this.setItem=function(i,s){void 0==s&&(s=i,i=t),n[e][i]=s},this.getItem=function(i){return void 0==i&&(i=t),void 0==n[e][i]?null:n[e][i]},this.removeItem=function(i){void 0==i&&(i=t),delete n[e][i]},this.getAllKeys=function(){return Object.keys(n[e])},void 0==n[e]&&this.clear()),this.isAvailable=function(){return s}},window.Persistence=new Persistence_sessionStorage,Persistence.isAvailable()||(window.Persistence=new Persistence_windowKey("py")),!Persistence.isAvailable()){var i=window.location.toString().indexOf("title"),n=window.location.toString().indexOf("main",i);i>0&&n>0&&n-i<10&&(window.Persistence=new Persistence_windowKey("qt"))}}

  var keyPrefix = "basic-sentences-recall";
  var UniqueCardPersistence = {
    getItem: function (key) {
      return Persistence.getItem(keyPrefix + "-" + key);
    },
    setItem: function (key, value) {
      return Persistence.setItem(keyPrefix + "-" + key, value);
    },
  };

  // Defaults management
  var switchIdList = [
    "text-pinyin",
    "text-zhuyin",
    "text-meaning",
    "text-sim",
    "text-trad",
    "text-examples",
    "text-examples-parts-of-speech",
  ];

  var preferenceDefaults = {
    "text-pinyin": { front: false, back: true },
    "text-zhuyin": { front: false, back: false },
    "text-meaning": { front: false, back: true },
    "text-sim": { front: true, back: true },
    "text-trad": { front: false, back: false },
    "text-examples": { front: true, back: true },
    "text-examples-parts-of-speech": { front: false, back: false }
  };

  function getPreference(defaultName, frontOrBack) {
    if (preferenceDefaults[defaultName] && preferenceDefaults[defaultName].hasOwnProperty(frontOrBack)) {
      return preferenceDefaults[defaultName][frontOrBack];
    } else {
      throw new Error("Invalid default name or property");
    }
  }
  // End defaults management

  var frontBack = "back";
  function setActive(side) {
    if (side == "text-front") {
      frontBack = "front";
      document.getElementById("text-front").classList.add("btn-active");
      document.getElementById("text-back").classList.remove("btn-active");
    }
    if (side == "text-back") {
      frontBack = "back";
      document.getElementById("text-front").classList.remove("btn-active");
      document.getElementById("text-back").classList.add("btn-active");
    }
    initSwitchPrefs();
  }

  if (!document.getElementById("back")) {
    setActive("text-front");
  } else {
    setActive("text-back");
  }

  function initPractice() {
    var _selectPracticeId = frontBack + "reading-practice-select";
    var selectPracticeElem = document.getElementById("reading-practice-select");
    var selectPracticeStore = UniqueCardPersistence.getItem(_selectPracticeId);

    if (selectPracticeStore == undefined) {
      selectPracticeElem.selectedIndex = 0;
      UniqueCardPersistence.setItem(_selectPracticeId, 0);
    } else {
      selectPracticeElem.selectedIndex = selectPracticeStore;
      UniqueCardPersistence.setItem(_selectPracticeId, selectPracticeStore);
    }
  }

  function initSwitchPrefs() {
    for (var _id of switchIdList) {
      var perId = frontBack + _id;

      var preferenceValue = UniqueCardPersistence.getItem(perId)
      if (preferenceValue === null) {
        preferenceValue = getPreference(_id, frontBack);
      } 

      document.getElementById(_id).checked = preferenceValue;
      UniqueCardPersistence.setItem(perId, preferenceValue);

      showHideFieldByCheckboxId(_id);
    }

    showTraditionalChar();
  }

  function showHideFieldByCheckboxId(_id) {
    var isShowField = document.getElementById(_id).checked ? true : false;
    showHideFieldByCheckboxIdWithIsShowField(_id, isShowField);
  }

  function showHideFieldByCheckboxIdWithIsShowField(_id, isShowField) {
    var divId = _id.replace("text-", "char_");

    // Use the generic showhide on the element first
    showHide("#" + divId, isShowField, "block");

    // Perform additional show/hide on special elements
    switch (_id) {
      case "text-pinyin":
        showHide(".pinyin", isShowField);
        break;

      case "text-zhuyin":
        showHide(".zhuyin", isShowField);
        break;

      case "text-examples-parts-of-speech":
        showHide(".char_examples-parts-of-speech", isShowField);
        break;

      case "text-sim":
        showHide("#char-sim-id", isShowField);
        break;

      case "text-trad":
        showHide("#char-trad-id", isShowField);
        showHide(".sep", isShowField);
        break;

      default:
        //console.warn(_id + " not in switch list");
        break;
    }
  }

  function showTraditionalChar() {
    var tradChar = document.getElementById("char_trad");
    var simChar = document.getElementById("char_sim");
    if (tradChar.innerHTML != simChar.innerHTML) {
      if (UniqueCardPersistence.getItem(frontBack + "text-trad") == "true") {
        tradChar.style.display = "block";
      }
    } else {
      if (UniqueCardPersistence.getItem(frontBack + "text-sim") == "true") {
        tradChar.style.display = "none";
      }
    }
  }

  function setPrefs(e) {
    var perId = frontBack + e.id;
    if (e.id == "reading-practice-select") {
      UniqueCardPersistence.setItem(perId, e.selectedIndex);
      characters =
        document.getElementById("reading-practice-select").selectedIndex == 0
          ? document.getElementById("char_sim").innerHTML
          : document.getElementById("char_trad").innerHTML;
      doPractice();
    }

    if (e.type == "checkbox") {
      UniqueCardPersistence.setItem(perId, e.checked.toString());
      var divId = e.id.replace("text-", "char_");

      showHideFieldByCheckboxId(e.id);
    }

    if (e.type == "number") {
      UniqueCardPersistence.setItem(perId, e.value);
      var elem = document.getElementById(e.id);
      elem.value = e.value;
    }
  }

  function showHide(type, isShow, style = "inline") {
    if (isShow) {
      document.querySelectorAll(type).forEach(function (val) {
        val.style.display = style;
      });
    } else {
      document.querySelectorAll(type).forEach(function (val) {
        val.style.display = "none";
      });
    }
  }

  function openSidebar(id) {
    var width = id == "sidebar" ? "250px" : "160px";
    document.getElementById(id).style.width = width;
  }

  function closeSidebar(id) {
    document.getElementById(id).style.width = "0";
  }

  document.addEventListener("click", function (event) {
    if (
      !document.getElementById("sidebar") ||
      !document.getElementById("more-info-sidebar")
    ) {
      return;
    }
    if (!document.getElementById("sidebar").contains(event.target)) {
      closeSidebar("sidebar");
    }
    if (!document.getElementById("more-info-sidebar").contains(event.target)) {
      closeSidebar("more-info-sidebar");
    }
    if (document.getElementById("btnShowMenu").contains(event.target)) {
      openSidebar("sidebar");
    }
    if (document.getElementById("btnMoreOptions").contains(event.target)) {
      openSidebar("more-info-sidebar");
    }
  });

  if (Persistence.isAvailable()) {
    if (window.ankiPlatform == "desktop" || isInWebView()) {
      initPractice();
      initSwitchPrefs();
    } else {
      window.addEventListener("load", initPractice, false);
      window.addEventListener("load", initSwitchPrefs, false);
    }
  }
  // audio in Anki Web on different systems

  function isInWebView() {
    var UA = navigator.userAgent;
    if (/iPhone|iPod|iPad/.test(UA)) {
      if (/(iPhone|iPod|iPad).*AppleWebKit(?!.*Safari)/i.test(UA)) {
        return true;
      }
    }
    if (window.location.href.includes("ankiuser.net")) {
      return true;
    }
    return false;
  }

  function btnTapAudio() {
    var audio = new Audio();
    audio.src = "_press.mp3";
    audio.load();
    audio.play();
  }

  function playAudio() {
    var audioDiv = document.getElementById("audio");
    var audio = audioDiv.getElementsByTagName("*");
    audio[0].tagName == "AUDIO" ? audio[0].play() : audio[0].click();
  }

  document.getElementById("btnPlayAudio").onclick = function () {
    playAudio();
  };

  var characters =
    document.getElementById("reading-practice-select").selectedIndex == "0"
      ? document.getElementById("char_sim").innerHTML
      : document.getElementById("char_trad").innerHTML;

  function doPractice(p = false) {
    if (document.getElementById("back")) {
      if (!p) {
        showNextAndRevealBtn(false);
        return;
      }
    }
  }

  function showNextAndRevealBtn(show) {
    showHide("#btnGoNextCard", show);
    showHide("#btnRevealChar", show);
  }

  if (Persistence.isAvailable()) {
    doPractice();
  }

  // Hack for iOS which isn't working properly (not respecting checkbox values)
  // TODO figure out why this is happening
  showHideFieldByCheckboxIdWithIsShowField("text-trad", false);
  showHideFieldByCheckboxIdWithIsShowField("text-zhuyin", false);

  var colorCodes = {
    1: "#f44336",
    2: "#ff9800",
    3: "#4caf50",
    4: "#2196f3",
    5: document.body.classList.contains("night_mode") ? "#fff" : "#555",
  };

  function decodePinyin(pinyin) {
    var coreVowels = ["a", "e", "i", "o", "u", "ü", "v"];
    var tonesArr = [];
    var buffer = [];

    function isCore(char, charPrevTwo, charNext) {
      if (
        char === "r" &&
        (charNext === " " || charNext === "") &&
        charPrevTwo !== " " &&
        charPrevTwo !== ""
      ) {
        return [true, true];
      }
      char = char
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase();
      for (var i = 0; i < coreVowels.length; i++) {
        if (char === coreVowels[i]) {
          return [true, false];
        }
      }
      return [false, false];
    }

    function getTone(str) {
      var pure = str.replace(/a|e|i|o|u|ü|r/g, "");
      if (pure === "") {
        return 5;
      } else if (["ā", "ē", "ī", "ō", "ū", "ǖ", "v̄"].indexOf(pure) !== -1) {
        return 1;
      } else if (["á", "é", "í", "ó", "ú", "ǘ", "v́"].indexOf(pure) !== -1) {
        return 2;
      } else if (["ǎ", "ě", "ǐ", "ǒ", "ǔ", "ǚ", "v̌"].indexOf(pure) !== -1) {
        return 3;
      } else if (["à", "è", "ì", "ò", "ù", "ǜ", "v̀"].indexOf(pure) !== -1) {
        return 4;
      } else {
        return 4; // Probably 绿 with v̀
      }
    }

    function flush() {
      if (buffer.length > 0) {
        tonesArr.push(getTone(buffer.join("")));
        buffer = [];
      }
    }

    for (var i = 0; i < pinyin.length; i++) {
      var result = isCore(pinyin[i], pinyin[i - 2], pinyin[i + 1]);
      if (result[1]) {
        flush();
      }
      if (result[0]) {
        buffer.push(pinyin[i]);
      } else {
        flush();
      }
    }

    if (buffer.length > 0) {
      tonesArr.push(getTone(buffer.join("")));
    }

    return tonesArr;
  }

  function recolorPinyin(pinyinElement, decodedTones) {
    var pinyinText = pinyinElement.innerHTML;
    var coloredPinyin = "";
    var wordIndex = 0;

    for (var i = 0; i < pinyinText.length; i++) {
      if (pinyinText[i] === " ") {
        coloredPinyin += " ";
        wordIndex++;
        continue;
      }
      var color = colorCodes[decodedTones[wordIndex]] || "#000"; // Default color to black if tone is not found
      coloredPinyin +=
        '<span style="color:' + color + ';">' + pinyinText[i] + "</span>";
    }

    pinyinElement.innerHTML = coloredPinyin;
  }

  function isChineseCharacter(char) {
    return /^[\u4e00-\u9fff]$/.test(char);
  }

  function recolorCharacters(characterElement, decodedTones) {
    var characterText = characterElement.innerHTML;
    var coloredCharacters = "";
    var wordIndex = 0;

    for (var i = 0; i < characterText.length; i++) {
      if (!isChineseCharacter([characterText[i]])) {
        coloredCharacters += characterText[i];
      } else {
        var color = colorCodes[decodedTones[wordIndex]] || "#555"; // Default color to grey if tone is not found
        coloredCharacters +=
          '<span style="color:' + color + ';">' + characterText[i] + "</span>";
        wordIndex++;
      }
    }

    characterElement.innerHTML = coloredCharacters;
  }
  
  function applyColorization() {
    var pinyinElement = document.getElementById("char_pinyin");
    if (!pinyinElement) {
      // console.warn(
      //   'Pinyin element not found with "#char_pinyin", will not attempt to recolour pinyin, simplified or traditional',
      // );
      return;
    }
    var decodedTones = decodePinyin(pinyinElement.innerHTML);
    recolorPinyin(pinyinElement, decodedTones);

    var hanziElement = document.getElementById("char_sim");
    if (hanziElement) {
      recolorCharacters(hanziElement, decodedTones);
    } else {
      // console.warn(
      //   'Simpliifed element not found with "#char_sim", will not attempt to recolour simplified',
      // );
    }

    var traditionalElement = document.getElementById("char_trad");
    var hanziElement = document.getElementById("char_sim");
    if (hanziElement) {
      recolorCharacters(traditionalElement, decodedTones);
    } else {
      // console.warn(
      //   'Traditional element not found with "#char_trad", will not attempt to recolour traditional',
      // );
    }
  }

  applyColorization(); // Call the function to apply the color when the script is executed
</script>

</script>

<script type="text/javascript">

  /**
   * Assign random class from this list to render the sentence in a different font every now and then
   * to help readers learn to read in more than one font.
   */
  function assignClassBasedOnTime() {
    // Get the char_sim element
    var charSimElement = document.getElementById("char_sim");

    // Get the current time
    var now = new Date();
    var minutes = now.getMinutes();
    var seconds = now.getSeconds();
    var segment = Math.floor((minutes * 60 + seconds) / 180); // Dividing total seconds in 3 minutes

    // Define the original class names you provided
    var classes = [
        "kaiti",
        "arial",
        "roboto",
        "yumincho"
    ];

    // Assign the class corresponding to the current 3-minute segment
    charSimElement.className = "char-card " + classes[segment % classes.length];
}

// Call the function to assign a class based on the current time
assignClassBasedOnTime();

</script>
