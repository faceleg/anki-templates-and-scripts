<div
    id="debug-message-console"
    style="
        display: none;
        color: red;
        border: 1px solid black;
        font-size: 8px;
        position: absolute;
        top: 0px;
        left: 0px;
        padding: 2px;
        max-width: 100%;
    "
></div>
<script type="text/javascript">
    function millisecondsSinceTimestamp(previousTimestamp) {
        // Get the current timestamp in milliseconds
        const currentTimestamp = Date.now();
    
        // Calculate the difference between current and previous timestamps
        const differenceMilliseconds = currentTimestamp - previousTimestamp;
    
        return differenceMilliseconds;
        }
    
        var loadStartedTimestamp = Date.now();
    
        // Set this to true to make the messenger appear with your messages
        var DEBUG = true;
        function printDebugMessage(message) {
        var messageDiv = document.getElementById("debug-message-console");
    
        messageDiv.style.display = DEBUG ? "block" : "none";
    
        messageDiv.innerHTML +=
            message +
            " (" +
            millisecondsSinceTimestamp(loadStartedTimestamp) +
            ")<br/>";
    }
</script>

<div id="split_sent">{{Split}}</div>

<div class="spacer"></div>

<div id="no-touch-wrapper" class="tappable">
    <div id="dash"></div>
    ______
    <div class="spacerSmall"></div>
    <div id="container"></div>
</div>
<div class="spacer"></div>
<button class="btn-check" onclick="check();">CHECK</button>
<button class="btn-reset" onclick="reset();">RESET</button>
<button class="btn-hint" onclick="hint();">HINT</button>
<div class="spacer"></div>
<div id="correct"></div>
<div class="spacer"></div>
<div class="spacer"></div>
<div id="structure" style="display:none" class="structure">{{Structure}}</div>
<div class="spacerMedium"></div>
<div id="chinese" class="chinese" style="display:none">{{Simplified}}</div>
<!-- <div class="spacerSmall"></div> -->
<div id="pinyin" class="pinyin" style="display:none">{{Pinyin}}</div>
<div class="spacerMedium"></div>
<div id="translation" class="translation">{{English}}</div>
<div class="spacer"></div>
<div id="usedfor" class="notes" style="display:none">{{Used For}}</div>
<script type="text/javascript">
/**
 * Stop skipping to next card on misclicks around buttons or interactive components
 */ 
(() => {
    const noTouchWrapper = document.getElementById('no-touch-wrapper');

    if (noTouchWrapper) {
        const allowedSelectors = ['button', '#container > div', '#dash > div'];

        function isAllowedTarget(target) {
            return allowedSelectors.some(selector => {
                return target.matches(selector) || target.closest(selector);
            });
        }

        function handleEvent(e) {
            if (isAllowedTarget(e.target)) {
                return;
            }
            e.preventDefault();
            e.stopImmediatePropagation();
        }

        const events = ['click', 'touchstart', 'touchmove', 'touchend', 'touchcancel'];

        events.forEach(eventType => {
            noTouchWrapper.addEventListener(eventType, handleEvent);
        });
    }
})();
</script>

<script>
(() => {
    // Hide the original sentence element
    const splitSentElement = document.getElementById("split_sent");
    splitSentElement.style.display = "none";

    // Process the sentence into an array of words
    const sentence = splitSentElement.innerText.trim();
    const sentenceArray = sentence.split(/\s+/);

    // Shuffle the array
    function shuffle(array) {
        array.sort(() => Math.random() - 0.5);
    }
    shuffle(sentenceArray);

    // Create buttons for each word with unique IDs
    let buttonHTML = "";
    sentenceArray.forEach((word, index) => {
        // Generate a unique ID using the word and its index
        const uniqueId = `btn${index}`;
        buttonHTML += `<div class='btn-q' id='${uniqueId}' onclick='btnClick("${uniqueId}")'>${word}</div>`;
    });

    // Add buttons to the container
    document.getElementById("container").innerHTML = buttonHTML;

    let picked = 0;

    // Handle clicks on buttons
    window.btnClick = function(clickedId) {
        const clickedElement = document.getElementById(clickedId);
        const text = clickedElement.innerText;

        // Create a new dash element and append it
        const dashElement = document.createElement("div");
        dashElement.style.display = "inline";
        const dashId = `dash${picked}`;
        dashElement.innerHTML = `<span class='btn-a' id='${dashId}' onclick='dashClick("${dashId}")'>${text}</span>`;
        document.getElementById("dash").appendChild(dashElement);

        // Mark the clicked button as used
        picked++;
        clickedElement.style.opacity = "0.2";
        clickedElement.style.pointerEvents = "none";
    };

    // Handle clicks on dash elements
    window.dashClick = function(clickedId) {
        const clickedElement = document.getElementById(clickedId);
        const clickedText = clickedElement.innerText.trim();
        const buttons = document.getElementsByClassName("btn-q");

        // Re-enable the corresponding button
        for (let button of buttons) {
            if (button.innerText.trim() === clickedText && button.style.pointerEvents === "none") {
                button.style.opacity = "1";
                button.style.pointerEvents = "auto";
                break;
            }
        }

        // Remove the dash element
        clickedElement.remove();
    };

    // Check if the current dash matches the original sentence
    window.check = function() {
        const dashElements = document.getElementById("dash").childNodes;
        let assembledText = Array.from(dashElements)
            .map(element => element.innerText)
            .join('')
            .replace(/\s+/g, '');
        

        const originalText = splitSentElement.innerText
            .replace(/\s+/g, '');

        const isCorrect = assembledText === originalText;

        document.getElementById("correct").innerText = isCorrect ? "CORRECT" : "INCORRECT";
        document.getElementById("correct").style.color = isCorrect ? "green" : "red";

        if (isCorrect) {
            ["chinese", "structure", "usedfor"].forEach(id => {
                document.getElementById(id).style.display = "block";
            });
        }
    };

    let hintTapCount = 0;

    // Reset the game state
    window.reset = function() {
        hintTapCount = 0;
        const buttons = document.getElementsByClassName("btn-q");
        for (let button of buttons) {
            button.style.opacity = "1";
            button.style.pointerEvents = "auto";
        }

        document.getElementById("dash").innerHTML = "";
        document.getElementById("correct").innerText = "";

        ["chinese", "pinyin", "structure", "usedfor"].forEach(id => {
            document.getElementById(id).style.display = "none";
        });
    };

    // Provide hints in stages
    window.hint = function() {
        const hints = ["structure", "chinese", "pinyin", "usedfor"];
        if (hintTapCount < hints.length) {
            document.getElementById(hints[hintTapCount]).style.display = "block";
            hintTapCount++;
        }
    };
})();
</script>
<script>
    (() => {
        var container = document.getElementById("container");
        var dash = document.getElementById("dash");
        if (container && dash) {
            var containerHeight = container.offsetHeight;
            dash.style.height = containerHeight + "px";
        }
    })();
</script>